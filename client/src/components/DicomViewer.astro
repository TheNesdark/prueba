---
// DicomViewer.astro
---

<div class="viewer-wrapper">
    <div id="dwv">
        <div id="layerGroup0"></div>
    </div>
</div>

<script>
    import { App, AppOptions, ViewConfig } from "dwv";
    import { serieActivaId } from "../stores/dicomStore";

    // Inicializar DWV
    const app = new App();
    const viewConfig0 = new ViewConfig("layerGroup0");
    const viewConfigs = { "*": [viewConfig0] };
    const options = new AppOptions(viewConfigs);

    // Esperar a que el DOM esté listo
    app.init(options);

    let currentObjectUrls = [];

    // Suscribirse a los cambios en el store
    serieActivaId.subscribe(async (serieId) => {
        if (!serieId) return;

        console.log("Cargando serie:", serieId);

        try {
            // 1. Obtener información de la serie para conseguir las instancias
            const response = await fetch(`/api/series/${serieId}`, {
                headers: {
                    "Bypass-Tunnel-Reminder": "true",
                },
            });

            if (!response.ok) throw new Error("Error al obtener la serie");
            const data = await response.json();
            const instances = data.Instances;

            console.log(`Encontradas ${instances.length} instancias.`);

            // 2. Obtener las imágenes (blobs)
            // Limpiar URLs anteriores para evitar fugas de memoria
            currentObjectUrls.forEach((url) => URL.revokeObjectURL(url));
            currentObjectUrls = [];

            const promises = instances.map(async (id) => {
                const r = await fetch(`/api/instances/${id}/file`, {
                    headers: {
                        Authorization: "Basic TUVESUNPOk1FRElDTw==",
                        "Bypass-Tunnel-Reminder": "true",
                    },
                });
                const blob = await r.blob();
                return URL.createObjectURL(blob);
            });

            const urls = await Promise.all(promises);
            currentObjectUrls = urls;

            // 3. Cargar en DWV
            if (urls.length > 0) {
                app.loadURLs(urls);
            }
        } catch (error) {
            console.error("Error cargando la serie:", error);
        }
    });
</script>

<style>
    .viewer-wrapper {
        width: 100%;
        height: 100%;
        position: relative;
        background-color: #000;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #dwv {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }

    /* Asegurar que el canvas de DWV se comporte bien */
    :global(.layerContainer) {
        width: 100%;
        height: 100%;
    }

    :global(.imageLayer) {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
</style>
