---
import type { DicomStudy } from "../services/Orthan";

interface Props {
  studies: DicomStudy[];
  currentPage: number;
  totalPages: number;
  total: number;
  limit: number;
}

const { studies, currentPage, totalPages, total, limit } = Astro.props;

interface FormattedStudy {
  id: string;
  shortId: string;
  patientName: string;
  patientId: string;
  studyDate: string;
  studyType: string;
  modality: string;
}

const formattedStudies: FormattedStudy[] = studies.map((study: DicomStudy) => ({
  id: study.ID,
  shortId: study.ID.substring(0, 8),
  patientName:
    study.PatientMainDicomTags?.PatientName?.replace(/\^/g, " ").trim() ||
    "Paciente Anónimo",
  patientId: study.PatientMainDicomTags?.PatientID || "Sin ID",
  studyDate: study.MainDicomTags?.StudyDate
    ? `${study.MainDicomTags.StudyDate.substring(0, 4)}-${study.MainDicomTags.StudyDate.substring(4, 6)}-${study.MainDicomTags.StudyDate.substring(6, 8)}`
    : "Sin fecha",
  studyType: study.MainDicomTags?.StudyDescription || "Estudio DICOM",
  modality: study.MainDicomTags?.ModalitiesInStudy || "IMG",
}));

const getPageNumbers = () => {
  const pages: (number | string)[] = [];
  if (totalPages <= 5) {
    for (let i = 1; i <= totalPages; i++) pages.push(i);
  } else {
    if (currentPage <= 3) {
      for (let i = 1; i <= 4; i++) pages.push(i);
      pages.push("...");
      pages.push(totalPages);
    } else if (currentPage >= totalPages - 2) {
      pages.push(1);
      pages.push("...");
      for (let i = totalPages - 3; i <= totalPages; i++) pages.push(i);
    } else {
      pages.push(1);
      pages.push("...");
      for (let i = currentPage - 1; i <= currentPage + 1; i++) pages.push(i);
      pages.push("...");
      pages.push(totalPages);
    }
  }
  return pages;
};

const pageNumbers = getPageNumbers();
const startItem = (currentPage - 1) * limit + 1;
const endItem = Math.min(currentPage * limit, total);
---

<div class="page-container">
  <header class="header">
    <div class="header-content">
      <div class="title-section">
        <div class="logo-icon">
          <svg
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </div>
        <div>
          <h1>Estudios DICOM</h1>
          <p class="subtitle">Sistema de Visualización Médica</p>
        </div>
      </div>

      <div class="header-actions">
        <div class="stats-badge">
          <span class="stats-number">{total}</span>
          <span class="stats-label">estudios</span>
        </div>

        <div class="search-container">
          <svg
            class="search-icon"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input
            type="search"
            id="search-input"
            placeholder="Buscar paciente..."
            autocomplete="off"
          />
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="table-container">
      <table id="studies-table">
        <thead>
          <tr>
            <th>Modalidad</th>
            <th>Paciente</th>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>ID</th>
          </tr>
        </thead>
        <tbody>
          {
            formattedStudies.map((study: FormattedStudy, index: number) => (
              <tr
                class="study-row"
                data-id={study.id}
                data-searchable={`${study.patientName} ${study.patientId} ${study.studyType}`.toLowerCase()}
                style={`--delay: ${index * 0.04}s`}
              >
                <td>
                  <span
                    class={`modality-chip modality-${study.modality.toLowerCase()}`}
                  >
                    {study.modality}
                  </span>
                </td>
                <td>
                  <div class="patient-cell">
                    <div class="patient-avatar">
                      {study.patientName.charAt(0).toUpperCase()}
                    </div>
                    <div class="patient-details">
                      <span class="patient-name">{study.patientName}</span>
                      <span class="patient-id">ID: {study.patientId}</span>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="date-text">{study.studyDate}</span>
                </td>
                <td>
                  <span class="description-text">{study.studyType}</span>
                </td>
                <td>
                  <code class="id-code">{study.shortId}</code>
                </td>
              </tr>
            ))
          }
        </tbody>
      </table>
      {
        formattedStudies.length === 0 && (
          <div class="empty-state">
            <p>No hay estudios</p>
          </div>
        )
      }
    </div>

    {
      totalPages > 1 && (
        <nav class="pagination">
          <div class="pagination-info">
            Mostrando{" "}
            <strong>
              {startItem}-{endItem}
            </strong>{" "}
            de <strong>{total}</strong>
          </div>
          <div class="pagination-controls">
            <a
              href={
                currentPage > 1
                  ? `/?page=${currentPage - 1}&limit=${limit}`
                  : "#"
              }
              class={`page-btn ${currentPage === 1 ? "disabled" : ""}`}
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="15 18 9 12 15 6" />
              </svg>
            </a>
            {pageNumbers.map((p) =>
              p === "..." ? (
                <span class="page-dots">...</span>
              ) : (
                <a
                  href={`/?page=${p}&limit=${limit}`}
                  class={`page-btn ${p === currentPage ? "active" : ""}`}
                >
                  {p}
                </a>
              ),
            )}
            <a
              href={
                currentPage < totalPages
                  ? `/?page=${currentPage + 1}&limit=${limit}`
                  : "#"
              }
              class={`page-btn ${currentPage === totalPages ? "disabled" : ""}`}
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="9 18 15 12 9 6" />
              </svg>
            </a>
          </div>
        </nav>
      )
    }
  </main>
</div>

<script>
  const searchInput = document.getElementById("search-input");
  const rows = document.querySelectorAll(".study-row");

  searchInput?.addEventListener("input", (e) => {
    const q = (e.target as HTMLInputElement).value.toLowerCase();
    rows.forEach(
      (r) =>
        ((r as HTMLElement).style.display =
          ((r as HTMLElement).dataset.searchable?.includes(q) ?? true)
            ? ""
            : "none"),
    );
  });

  rows.forEach((r) =>
    r.addEventListener("click", () => {
      r.classList.add("navigating");
      setTimeout(
        () =>
          (window.location.href = `/viewer/${(r as HTMLElement).dataset.id}`),
        150,
      );
    }),
  );
</script>

<style>
  .page-container {
    --primary: #2563eb;
    --primary-light: #3b82f6;
    --accent: #10b981;
    --accent-light: #34d399;
    --bg-white: #ffffff;
    --bg-light: #f0fdf4;
    --bg-blue-light: #eff6ff;
    --border: #e0f2fe;
    --border-green: #bbf7d0;
    --text-dark: #1e293b;
    --text-secondary: #475569;
    --text-muted: #94a3b8;

    display: flex;
    flex-direction: column;
    height: calc(100vh - 48px);
    background: linear-gradient(
      135deg,
      var(--bg-blue-light) 0%,
      var(--bg-light) 100%
    );
    font-family:
      "Inter",
      -apple-system,
      sans-serif;
  }

  .header {
    background: var(--bg-white);
    border-bottom: 2px solid var(--border-green);
    padding: 20px 32px;
    box-shadow: 0 4px 20px rgba(37, 99, 235, 0.08);
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .title-section {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-icon {
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    border-radius: 14px;
    color: white;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
  }

  h1 {
    font-size: 26px;
    font-weight: 700;
    color: var(--text-dark);
    margin: 0;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .subtitle {
    font-size: 13px;
    color: var(--text-muted);
    margin: 4px 0 0;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .stats-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    background: linear-gradient(
      135deg,
      var(--bg-blue-light) 0%,
      var(--bg-light) 100%
    );
    border: 1px solid var(--border-green);
    border-radius: 30px;
  }

  .stats-number {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
  }

  .stats-label {
    font-size: 13px;
    color: var(--text-muted);
  }

  .search-container {
    position: relative;
  }

  .search-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
  }

  .search-container input {
    width: 260px;
    padding: 12px 16px 12px 44px;
    background: var(--bg-white);
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text-dark);
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .search-container input:focus {
    outline: none;
    border-color: var(--primary-light);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
  }

  .main-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .table-container {
    background: var(--bg-white);
    border: 1px solid var(--border-green);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.08);
    flex: 1;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th {
    background: linear-gradient(
      135deg,
      var(--bg-blue-light) 0%,
      var(--bg-light) 100%
    );
    padding: 16px 20px;
    text-align: left;
    font-size: 11px;
    font-weight: 700;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--border-green);
  }

  .study-row {
    cursor: pointer;
    transition: all 0.2s ease;
    animation: fadeIn 0.4s ease forwards;
    animation-delay: var(--delay);
    opacity: 0;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(6px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .study-row:hover {
    background: linear-gradient(
      90deg,
      rgba(37, 99, 235, 0.05) 0%,
      rgba(16, 185, 129, 0.05) 100%
    );
  }

  .study-row.navigating {
    background: rgba(37, 99, 235, 0.1);
    transform: scale(0.99);
  }

  td {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .modality-chip {
    display: inline-flex;
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .modality-ct {
    background: #dbeafe;
    color: #1d4ed8;
  }
  .modality-mr {
    background: #ede9fe;
    color: #6d28d9;
  }
  .modality-rx,
  .modality-cr,
  .modality-dx {
    background: #d1fae5;
    color: #047857;
  }
  .modality-us {
    background: #fef3c7;
    color: #b45309;
  }
  .modality-nm,
  .modality-pt {
    background: #fce7f3;
    color: #be185d;
  }
  .modality-img {
    background: #f1f5f9;
    color: #475569;
  }

  .patient-cell {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .patient-avatar {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 600;
    color: white;
    box-shadow: 0 3px 10px rgba(37, 99, 235, 0.25);
  }

  .patient-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .patient-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dark);
  }

  .patient-id {
    font-size: 11px;
    color: var(--text-muted);
  }

  .date-text {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .description-text {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .id-code {
    font-family: "JetBrains Mono", monospace;
    font-size: 11px;
    padding: 5px 10px;
    background: var(--bg-blue-light);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--primary);
  }

  .empty-state {
    padding: 60px;
    text-align: center;
    color: var(--text-muted);
  }

  .pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 16px 20px;
    background: var(--bg-white);
    border: 1px solid var(--border-green);
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(16, 185, 129, 0.06);
    flex-wrap: wrap;
  }

  .pagination-info {
    font-size: 13px;
    color: var(--text-muted);
  }

  .pagination-info strong {
    color: var(--text-dark);
  }

  .pagination-controls {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .page-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 38px;
    height: 38px;
    padding: 0 12px;
    background: var(--bg-white);
    border: 2px solid var(--border);
    border-radius: 10px;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .page-btn:hover:not(.disabled):not(.active) {
    border-color: var(--primary-light);
    color: var(--primary);
    background: var(--bg-blue-light);
  }

  .page-btn.active {
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    border-color: transparent;
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  .page-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .page-dots {
    color: var(--text-muted);
    padding: 0 4px;
  }

  @media (max-width: 768px) {
    .header {
      padding: 16px;
    }
    .header-content {
      flex-direction: column;
      align-items: stretch;
    }
    .search-container input {
      width: 100%;
    }
    .main-content {
      padding: 16px;
    }
    .pagination {
      flex-direction: column;
      text-align: center;
    }
    .pagination-controls {
      justify-content: center;
    }
    .patient-avatar {
      display: none;
    }
  }

  .main-content::-webkit-scrollbar {
    width: 8px;
  }
  .main-content::-webkit-scrollbar-track {
    background: var(--bg-light);
  }
  .main-content::-webkit-scrollbar-thumb {
    background: var(--border-green);
    border-radius: 4px;
  }
</style>
